<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Músicas</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-900 text-white p-6">
    <div class="max-w-5xl mx-auto">
        <h1 class="text-3xl font-bold text-white mb-6">Minhas Músicas</h1>
        
        <!-- Player de Música -->
        <div class="bg-gray-800 p-6 rounded-lg shadow-lg mb-8">
            <div class="flex items-center justify-between mb-4">
                <div class="flex-1">
                    <div id="player-info" class="text-sm">
                        <span class="font-bold text-white" id="player-title">Nenhuma música selecionada</span>
                        <span class="text-gray-400 ml-2" id="player-artist"></span>
                    </div>
                    <div class="text-xs text-gray-500 mt-1" id="player-album"></div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <button id="prev-button" class="bg-gray-600 hover:bg-gray-500 text-white font-bold p-2 rounded-full transition-colors duration-200">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M8.445 14.832A1 1 0 0010 14v-2.798l5.445 3.63A1 1 0 0017 14V6a1 1 0 00-1.555-.832L10 8.798V6a1 1 0 00-1.555-.832l-6 4a1 1 0 000 1.664l6 4z"/>
                        </svg>
                    </button>
                    
                    <button id="play-button" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-4 rounded-full transition-colors duration-200">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"/>
                        </svg>
                    </button>
                    
                    <button id="pause-button" class="hidden bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-full transition-colors duration-200">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"/>
                        </svg>
                    </button>
                    
                    <button id="next-button" class="bg-gray-600 hover:bg-gray-500 text-white font-bold p-2 rounded-full transition-colors duration-200">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M4.555 5.168A1 1 0 003 6v8a1 1 0 001.555.832L10 11.202V14a1 1 0 001.555.832l6-4a1 1 0 000-1.664l-6-4A1 1 0 0010 6v2.798l-5.445-3.63z"/>
                        </svg>
                    </button>
                </div>
            </div>
            
            <!-- Barra de progresso -->
            <div class="flex items-center space-x-3">
                <span id="current-time" class="text-xs text-gray-400">0:00</span>
                <div class="flex-1 bg-gray-700 rounded-full h-2">
                    <div id="progress-bar" class="bg-teal-500 h-2 rounded-full w-0"></div>
                </div>
                <span id="duration" class="text-xs text-gray-400">0:00</span>
            </div>
            
            <audio id="audio-player" src="" class="hidden"></audio>
        </div>

        <!-- Controles de busca e ordenação -->
        <div class="bg-gray-800 p-6 rounded-lg shadow-lg mb-6">
            <div class="flex flex-col md:flex-row gap-4">
                <!-- Campo de busca -->
                <div class="flex-1">
                    <input type="search" id="search-input" placeholder="Buscar por título ou artista..."
                           class="w-full p-3 rounded bg-gray-700 border border-gray-600 text-white placeholder-gray-400 focus:outline-none focus:border-teal-500 transition-colors">
                </div>
                
                <!-- Seletor de ordenação (Atividade de Casa) -->
                <div class="w-full md:w-64">
                    <select id="sort-select" class="w-full p-3 rounded bg-gray-700 border border-gray-600 text-white focus:outline-none focus:border-teal-500 transition-colors">
                        <option value="titulo">Ordenar por Título</option>
                        <option value="artista">Ordenar por Artista</option>
                        <option value="album">Ordenar por Álbum</option>
                        <option value="data_adicao">Ordenar por Data</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Tabela de músicas -->
        <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
            <table class="w-full text-left">
                <thead class="bg-gray-700">
                    <tr>
                        <th class="p-3 font-semibold text-white">Título</th>
                        <th class="p-3 font-semibold text-white">Artista</th>
                        <th class="p-3 font-semibold text-white">Álbum</th>
                        <th class="p-3 font-semibold text-white">Ações</th>
                    </tr>
                </thead>
                <tbody id="songs-table-body" class="divide-y divide-gray-700">
                    <tr>
                        <td colspan="4" class="p-4 text-center text-gray-500">Carregando músicas...</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="mt-4 text-center">
            <a href="index.html" class="text-red-600 hover:text-red-500 inline-flex items-center">
                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                </svg>
                Voltar para o Player
            </a>
        </div>
    </div>

    <script>
        // Elementos do player
        const audioPlayer = document.getElementById('audio-player');
        const playButton = document.getElementById('play-button');
        const pauseButton = document.getElementById('pause-button');
        const prevButton = document.getElementById('prev-button');
        const nextButton = document.getElementById('next-button');
        const playerTitle = document.getElementById('player-title');
        const playerArtist = document.getElementById('player-artist');
        const playerAlbum = document.getElementById('player-album');
        const progressBar = document.getElementById('progress-bar');
        const currentTimeEl = document.getElementById('current-time');
        const durationEl = document.getElementById('duration');
        const searchInput = document.getElementById('search-input');
        const sortSelect = document.getElementById('sort-select');

        // Variáveis globais
        let allSongs = [];
        let currentSongIndex = -1;
        let currentSearchTerm = '';
        let currentSortBy = 'titulo';

        // Função para carregar músicas com busca e ordenação
        async function fetchSongs(searchTerm = '', sortBy = 'titulo') {
            try {
                let url = `http://localhost/player-de-musica/src/list_songs.php?sort=${sortBy}`;
                if (searchTerm) {
                    url += `&search=${encodeURIComponent(searchTerm)}`;
                }
                
                const response = await fetch(url);
                const result = await response.json();
                const tableBody = document.getElementById('songs-table-body');
                tableBody.innerHTML = '';
                
                if (result.status === 'sucesso' && result.data.length > 0) {
                    allSongs = result.data;
                    
                    result.data.forEach((song) => {
                        const row = document.createElement('tr');
                        row.className = 'hover:bg-gray-750 transition-colors';
                        row.innerHTML = `
                            <td class="p-3 text-white">${song.titulo}</td>
                            <td class="p-3 text-gray-300">${song.artista}</td>
                            <td class="p-3 text-gray-400">${song.album || 'N/A'}</td>
                            <td class="p-3">
                                <button onclick="playSong(${song.id})" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-1 px-3 rounded text-xs transition-colors duration-200">
                                    Play
                                </button>
                                <button onclick="editSong(${song.id})" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-1 px-3 rounded text-xs transition-colors duration-200 ml-2">
                                    Editar
                                </button>
                                <button onclick="deleteSong(${song.id})" class="bg-red-600 hover:bg-red-500 text-white font-bold py-1 px-3 rounded text-xs transition-colors duration-200 ml-2">
                                    Excluir
                                </button>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                    
                    // Reaplica o destaque na música atual após recarregar
                    if (currentSongIndex !== -1) {
                        highlightCurrentSong();
                    }
                } else {
                    tableBody.innerHTML = '<tr><td colspan="4" class="text-center p-4 text-gray-500">Nenhuma música encontrada.</td></tr>';
                }
            } catch (error) {
                console.error('Erro:', error);
                const tableBody = document.getElementById('songs-table-body');
                tableBody.innerHTML = '<tr><td colspan="4" class="text-center p-4 text-red-500">Erro ao carregar músicas.</td></tr>';
            }
        }

        // Função para tocar música
        function playSong(id) {
            const song = allSongs.find(s => s.id == id);
            if (song) {
                currentSongIndex = allSongs.indexOf(song);
                audioPlayer.src = `../music_files/${song.caminho_arquivo}`;
                audioPlayer.play();
                
                playerTitle.textContent = song.titulo;
                playerArtist.textContent = `- ${song.artista}`;
                playerAlbum.textContent = song.album || '';
                
                playButton.classList.add('hidden');
                pauseButton.classList.remove('hidden');
                
                highlightCurrentSong();
            }
        }

        // Função para próxima música
        function nextSong() {
            if (allSongs.length === 0) return;
            currentSongIndex = (currentSongIndex + 1) % allSongs.length;
            playSong(allSongs[currentSongIndex].id);
        }

        // Função para música anterior
        function prevSong() {
            if (allSongs.length === 0) return;
            currentSongIndex = (currentSongIndex - 1 + allSongs.length) % allSongs.length;
            playSong(allSongs[currentSongIndex].id);
        }

        // Função para pausar música
        function pauseSong() {
            audioPlayer.pause();
            playButton.classList.remove('hidden');
            pauseButton.classList.add('hidden');
        }

        // Função para destacar a música atual na tabela
        function highlightCurrentSong() {
            const rows = document.querySelectorAll('#songs-table-body tr');
            rows.forEach((row, index) => {
                if (index === currentSongIndex) {
                    row.classList.add('bg-teal-900', 'bg-opacity-30');
                } else {
                    row.classList.remove('bg-teal-900', 'bg-opacity-30');
                }
            });
        }

        // Função para formatar tempo
        function formatTime(seconds) {
            const min = Math.floor(seconds / 60);
            const sec = Math.floor(seconds % 60);
            return `${min}:${sec.toString().padStart(2, '0')}`;
        }

        // Debounce function para evitar muitas requisições durante a digitação
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Atualizar barra de progresso
        audioPlayer.addEventListener('timeupdate', () => {
            const currentTime = audioPlayer.currentTime;
            const duration = audioPlayer.duration;
            
            if (duration) {
                const progressPercent = (currentTime / duration) * 100;
                progressBar.style.width = `${progressPercent}%`;
                currentTimeEl.textContent = formatTime(currentTime);
                durationEl.textContent = formatTime(duration);
            }
        });

        // Quando a música termina, tocar próxima
        audioPlayer.addEventListener('ended', nextSong);

        // Event listeners do player
        playButton.addEventListener('click', () => {
            if (currentSongIndex !== -1) {
                audioPlayer.play();
                playButton.classList.add('hidden');
                pauseButton.classList.remove('hidden');
            } else if (allSongs.length > 0) {
                playSong(allSongs[0].id);
            }
        });

        pauseButton.addEventListener('click', pauseSong);
        nextButton.addEventListener('click', nextSong);
        prevButton.addEventListener('click', prevSong);

        // Event listeners para busca e ordenação
        searchInput.addEventListener('input', debounce((event) => {
            currentSearchTerm = event.target.value;
            fetchSongs(currentSearchTerm, currentSortBy);
        }, 300));

        sortSelect.addEventListener('change', (event) => {
            currentSortBy = event.target.value;
            fetchSongs(currentSearchTerm, currentSortBy);
        });

        // Funções de edição e exclusão
        async function deleteSong(id) {
            if (!confirm('Tem certeza que deseja excluir esta música?')) {
                return;
            }
            
            try {
                const response = await fetch(`http://localhost/player-de-musica/src/delete_song.php?id=${id}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                alert(result.mensagem);
                fetchSongs(currentSearchTerm, currentSortBy);
                
                if (currentSongIndex !== -1 && allSongs[currentSongIndex] && allSongs[currentSongIndex].id == id) {
                    audioPlayer.pause();
                    audioPlayer.src = '';
                    playerTitle.textContent = 'Nenhuma música selecionada';
                    playerArtist.textContent = '';
                    playerAlbum.textContent = '';
                    playButton.classList.remove('hidden');
                    pauseButton.classList.add('hidden');
                    currentSongIndex = -1;
                }
                
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao excluir música. Verifique a conexão com o servidor.');
            }
        }

        function editSong(id) {
            window.location.href = `edit.html?id=${id}`;
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            fetchSongs();
        });
    </script>
</body>
</html>